<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tic Tac Toe – Multiplayer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: #8B9E9D;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 30px 20px;
    color: white;
  }

  h1 {
    margin-bottom: 10px;
  }

  #lobby {
    background: rgba(255,255,255,0.15);
    padding: 14px 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }

  #lobby p {
    margin: 6px 0;
    font-size: 18px;
  }

  #board {
    display: none;
    grid-template-columns: repeat(3, 120px);
    gap: 10px;
    margin-top: 20px;
  }

  .cell {
    width: 120px;
    height: 120px;
    background: #D4C5B9;
    border-radius: 12px;
    font-size: 70px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #2D2424;
    cursor: pointer;
    transition: 0.2s;
  }

  .cell:hover {
    transform: scale(1.04);
  }

  #status {
    margin-top: 20px;
    background: rgba(0,0,0,0.25);
    padding: 10px 20px;
    border-radius: 12px;
    font-size: 20px;
  }

  button {
    background: #4a6556;
    color: white;
    padding: 10px 16px;
    border: none;
    border-radius: 8px;
    margin-top: 10px;
    cursor: pointer;
    font-weight: bold;
    transition: 0.2s;
  }

  button:hover {
    transform: scale(1.05);
  }

</style>
</head>
<body>

<h1>❌⭕ Tic Tac Toe</h1>

<div id="lobby">
  <p><b>Room:</b> <span id="roomId"></span></p>
  <p>Players: <span id="playersCount">0</span>/2</p>
  <p id="lobbyStatus">Waiting for players…</p>
  <button id="readyBtn" style="display:none;">Ready</button>
  <button id="startBtn" style="display:none;">Start Game</button>
</div>

<div id="board"></div>

<div id="status"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ----------------------------------------------------------
   BASIC ROOM SETUP
---------------------------------------------------------- */

const params = new URLSearchParams(location.search);
const ROOM_ID = params.get("room");
document.getElementById("roomId").textContent = ROOM_ID;

const PLAYER_ID = crypto.randomUUID().slice(0,8);

let players = {};
let playerOrder = [];
let mySymbol = null; // X or O
let gameStarted = false;

const supabase = supabase.createClient(
    "https://vehaakunkgxwuzdrlfut.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZlaGFha3Vua2d4d3V6ZHJsZnV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MjQ3NTUsImV4cCI6MjA4MDAwMDc1NX0.9ZIY7yMIk_eygIw-Q9YJStc8d9HTp_kswJ2Uuq2JQJo"
);

const channel = supabase.channel("ttt_" + ROOM_ID, {
  config: { broadcast: { self:false }}
});

/* ----------------------------------------------------------
   UI ELEMENTS
---------------------------------------------------------- */
const lobbyStatus = document.getElementById("lobbyStatus");
const playersCount = document.getElementById("playersCount");
const readyBtn = document.getElementById("readyBtn");
const startBtn = document.getElementById("startBtn");
const board = document.getElementById("board");
const statusBox = document.getElementById("status");

/* ----------------------------------------------------------
   BOARD SETUP
---------------------------------------------------------- */
let boardState = ["", "", "", "", "", "", "", "", ""];
let turn = null;

for (let i = 0; i < 9; i++) {
  const cell = document.createElement("div");
  cell.className = "cell";
  cell.dataset.index = i;
  cell.onclick = () => tryMove(i);
  board.appendChild(cell);
}

/* ----------------------------------------------------------
   BROADCAST HANDLERS
---------------------------------------------------------- */

// Player joined
channel.on("broadcast", {event:"join"}, ({payload}) => {
  players[payload.id] = { ready:false };
  updateLobby();
});

// Player ready
channel.on("broadcast", {event:"ready"}, ({payload}) => {
  players[payload.id].ready = true;
  updateLobby();
});

// Game state update
channel.on("broadcast", {event:"state"}, ({payload}) => {
  boardState = payload.boardState;
  turn = payload.turn;
  mySymbol = payload.symbols[PLAYER_ID];

  renderBoard();
  statusBox.textContent = (turn === PLAYER_ID) ?
      "Your turn (" + mySymbol + ")" :
      "Opponent's turn";

  board.style.display = "grid";
});

/* Subscribe */
channel.subscribe(() => {
  // Announce join
  channel.send({
    type:"broadcast",
    event:"join",
    payload:{ id:PLAYER_ID }
  });

  updateLobby();
});

/* ----------------------------------------------------------
   LOBBY LOGIC
---------------------------------------------------------- */

function updateLobby() {
  const count = Object.keys(players).length;
  playersCount.textContent = count;

  // Leader = first player in room
  const isLeader = Object.keys(players)[0] === PLAYER_ID;

  if (!gameStarted) {
    if (count === 1) {
      lobbyStatus.textContent = "Waiting for opponent…";
      readyBtn.style.display = "none";
      startBtn.style.display = "none";
    }
    else if (count === 2) {
      lobbyStatus.textContent = "Both players joined.";

      if (isLeader) {
        startBtn.style.display = "block";
        readyBtn.style.display = "none";
      } else {
        readyBtn.style.display = "block";
        startBtn.style.display = "none";
      }
    }
  }
}

/* Player click READY */
readyBtn.onclick = () => {
  channel.send({
    type:"broadcast",
    event:"ready",
    payload:{ id:PLAYER_ID }
  });

  readyBtn.textContent = "Ready ✔";
  readyBtn.disabled = true;
};

/* Leader clicks START */
startBtn.onclick = () => {
  if (Object.keys(players).length < 2) return;

  startGame();
};

/* ----------------------------------------------------------
   START GAME
---------------------------------------------------------- */
function startGame() {
  gameStarted = true;

  const ids = Object.keys(players);

  const symbols = {
    [ids[0]]: "X",
    [ids[1]]: "O"
  };

  turn = ids[0];

  channel.send({
    type:"broadcast",
    event:"state",
    payload: {
      boardState,
      turn,
      symbols
    }
  });

  lobby.style.display = "none";
  board.style.display = "grid";
}

/* ----------------------------------------------------------
   ATTEMPT MOVE
---------------------------------------------------------- */
function tryMove(index) {
  if (turn !== PLAYER_ID) return;
  if (boardState[index] !== "") return;

  boardState[index] = mySymbol;

  // Switch turn
  const ids = Object.keys(players);
  turn = (turn === ids[0]) ? ids[1] : ids[0];

  channel.send({
    type:"broadcast",
    event:"state",
    payload: {
      boardState,
      turn,
      symbols: {
        [ids[0]]: "X",
        [ids[1]]: "O"
      }
    }
  });

  checkWinner();
}

/* ----------------------------------------------------------
   WIN CHECK
---------------------------------------------------------- */

function checkWinner() {
  const wins = [
    [0,1,2],[3,4,5],[6,7,8], // rows
    [0,3,6],[1,4,7],[2,5,8], // cols
    [0,4,8],[2,4,6]          // diagonals
  ];

  for (let w of wins) {
    const [a,b,c] = w;
    if (boardState[a] &&
        boardState[a] === boardState[b] &&
        boardState[a] === boardState[c]) {

      setTimeout(() => {
        alert("Winner: " + boardState[a]);
        location.reload();
      }, 200);
    }
  }
}

/* ----------------------------------------------------------
   RENDER BOARD
---------------------------------------------------------- */
function renderBoard() {
  const cells = document.querySelectorAll(".cell");
  cells.forEach((cell, i) => {
    cell.textContent = boardState[i];
  });
}

</script>
</body>
</html>
